
##  Encrypt with an RSA key generated by the TPM


1. First create a primary key

```bash
$ tpm2_createprimary -C e -c primary.ctx
```

We are using the `e`ndorsement hierarchy.


2. Create a child key enabled for decryption.

Export the pub, priv portions as `key.pub`, `key.priv`

```bash
$ tpm2_create -G rsa -u key.pub -r key.priv -C primary.ctx
```


3. Load the key context

```bash
$ tpm2_load -C primary.ctx -u key.pub -r key.priv -c key.ctx
$ tpm2_evictcontrol -C o -c key.ctx 0x81010002
```

Key context is `key.ctx` and also as persistent handle `0x81010002`


4. Create a secret file

```bash
$ echo "meet me at..." > secret.txt
```

5. Encrypt `secret.txt` with the key context

```bash
$ tpm2_rsaencrypt -c key.ctx   -o secret.txt.enc secret.txt
```

At this point `secret.txt.enc` is encrypted.


6. Decrypt the encrypted file

```bash
tpm2_rsadecrypt -c key.ctx -o secret.txt.dec  secret.txt.enc

more secret.txt.dec
 meet me at...
```
---


## Convert the TPM loaded public key to PEM and encrypt with public key using openssl

7. Export the public key in PEM format

```bash
$ tpm2_readpublic -c key.ctx -f PEM -o key.pem
```


```bash
$ more key.pem 
-----BEGIN PUBLIC KEY-----
MIIBI....
-----END PUBLIC KEY-----
```

8. Encrypt some file with the public portion
```bash
$ echo "foo" > rsa_external.txt
$ openssl rsautl -encrypt -inkey key.pem -pubin -in rsa_external.txt -out rsa_external.txt.enc
```

9. Decrypt it w/ the tpm

```bash
$ tpm2_rsadecrypt -c key.ctx -o rsa_external.txt.ptext rsa_external.txt.enc

$ more rsa_external.txt.ptext
  foo
```

---

```
// # go run main.go -handle=0x81010002  --logtostderr=1 -v 5
// I1028 23:25:07.038792    9297 main.go:33] ======= Init  ========
// I1028 23:25:07.052022    9297 main.go:60] 0 handles flushed
// I1028 23:25:07.054913    9297 main.go:75] Encrypted Data BYuDlnZ+oU...
// I1028 23:25:07.060076    9297 main.go:81] Decrypted Data meet me at...
```