<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    
    <title>6equj5.dev  | Envoy Global rate limiting helloworld</title>
    <meta name="viewport" content="width=device-width,minimum-scale=1">
    <meta name="generator" content="Hugo 0.54.0" />
    
    
      <META NAME="ROBOTS" CONTENT="INDEX, FOLLOW">
    

    
    
      <link href="/dist/css/app.d98f2eb6bcd1eaedb7edf166bd16af26.css" rel="stylesheet">
    

    

    
      
    

    
    
    <meta property="og:title" content="Envoy Global rate limiting helloworld" />
<meta property="og:description" content="Sample &ldquo;hello world&rdquo; application demonstrating basic aspects fo Envoy&rsquo;s Global Rate Limiting capability. This app configures a local envoy instance for an HTTP level rate limit filter and then uses Lyft&rsquo;s RateLimit Service as the backend.
Envoy&rsquo;s rate limit functions checks each request to see if it should go through or not either using a local instance specific criteria or globally. By local, the rate limit counter runs within the context of the single envoy proxy that handles the request." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://blog.6equj5.dev/posts/envoy_ratelimit/" />
<meta property="article:published_time" content="2019-10-22T14:34:01-08:00"/>
<meta property="article:modified_time" content="2019-10-22T14:34:01-08:00"/>

<meta itemprop="name" content="Envoy Global rate limiting helloworld">
<meta itemprop="description" content="Sample &ldquo;hello world&rdquo; application demonstrating basic aspects fo Envoy&rsquo;s Global Rate Limiting capability. This app configures a local envoy instance for an HTTP level rate limit filter and then uses Lyft&rsquo;s RateLimit Service as the backend.
Envoy&rsquo;s rate limit functions checks each request to see if it should go through or not either using a local instance specific criteria or globally. By local, the rate limit counter runs within the context of the single envoy proxy that handles the request.">


<meta itemprop="datePublished" content="2019-10-22T14:34:01-08:00" />
<meta itemprop="dateModified" content="2019-10-22T14:34:01-08:00" />
<meta itemprop="wordCount" content="1688">



<meta itemprop="keywords" content="envoy," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Envoy Global rate limiting helloworld"/>
<meta name="twitter:description" content="Sample &ldquo;hello world&rdquo; application demonstrating basic aspects fo Envoy&rsquo;s Global Rate Limiting capability. This app configures a local envoy instance for an HTTP level rate limit filter and then uses Lyft&rsquo;s RateLimit Service as the backend.
Envoy&rsquo;s rate limit functions checks each request to see if it should go through or not either using a local instance specific criteria or globally. By local, the rate limit counter runs within the context of the single envoy proxy that handles the request."/>

      
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-155117088-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

    
  </head>

  <body class="ma0 avenir bg-near-white production">

    
   
  

  
  
  <header class="cover bg-top" style="background-image: url('https://blog.6equj5.dev/posts/envoy_ratelimit/images/envoy.png');">
    <div class="pb3-m pb6-l bg-black-60">
      <nav class="pv3 ph3 ph4-ns" role="navigation">
  <div class="flex-l justify-between items-center center">
    <a href="https://blog.6equj5.dev/" class="f3 fw2 hover-white no-underline white-90 dib">
      6equj5.dev
    </a>
    <div class="flex-l items-center">
      

      
        <ul class="pl0 mr3">
          
          <li class="list f5 f4-ns fw4 dib pr3">
            <a class="hover-white no-underline white-90" href="/posts/" title="Articles page">
              Articles
            </a>
          </li>
          
          <li class="list f5 f4-ns fw4 dib pr3">
            <a class="hover-white no-underline white-90" href="/about/" title="EHELO sal page">
              EHELO sal
            </a>
          </li>
          
        </ul>
      
      






<a href="https://www.linkedin.com/in/salmaan-rashid-26b648" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedIn——Opens in a new window">
  <svg  height="32px"  style="enable-background:new 0 0 65 65;" version="1.1" viewBox="0 0 65 65" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
  <path d="M50.837,48.137V36.425c0-6.275-3.35-9.195-7.816-9.195  c-3.604,0-5.219,1.983-6.119,3.374V27.71h-6.79c0.09,1.917,0,20.427,0,20.427h6.79V36.729c0-0.609,0.044-1.219,0.224-1.655  c0.49-1.22,1.607-2.483,3.482-2.483c2.458,0,3.44,1.873,3.44,4.618v10.929H50.837z M22.959,24.922c2.367,0,3.842-1.57,3.842-3.531  c-0.044-2.003-1.475-3.528-3.797-3.528s-3.841,1.524-3.841,3.528c0,1.961,1.474,3.531,3.753,3.531H22.959z M34,64  C17.432,64,4,50.568,4,34C4,17.431,17.432,4,34,4s30,13.431,30,30C64,50.568,50.568,64,34,64z M26.354,48.137V27.71h-6.789v20.427  H26.354z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/>
</svg>

<span class="new-window"><svg  height="8px"  style="enable-background:new 0 0 1000 1000;" version="1.1" viewBox="0 0 1000 1000" width="8px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
<path d="M598 128h298v298h-86v-152l-418 418-60-60 418-418h-152v-86zM810 810v-298h86v298c0 46-40 86-86 86h-596c-48 0-86-40-86-86v-596c0-46 38-86 86-86h298v86h-298v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/>
</svg>
</span></a>


<a href="https://github.com/salrashid123" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="Github link" rel="noopener" aria-label="follow on Github——Opens in a new window">
  <svg  height="32px"  style="enable-background:new 0 0 512 512;" version="1.1" viewBox="0 0 512 512" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
  <path d="M256,32C132.3,32,32,134.8,32,261.7c0,101.5,64.2,187.5,153.2,217.9c11.2,2.1,15.3-5,15.3-11.1   c0-5.5-0.2-19.9-0.3-39.1c-62.3,13.9-75.5-30.8-75.5-30.8c-10.2-26.5-24.9-33.6-24.9-33.6c-20.3-14.3,1.5-14,1.5-14   c22.5,1.6,34.3,23.7,34.3,23.7c20,35.1,52.4,25,65.2,19.1c2-14.8,7.8-25,14.2-30.7c-49.7-5.8-102-25.5-102-113.5   c0-25.1,8.7-45.6,23-61.6c-2.3-5.8-10-29.2,2.2-60.8c0,0,18.8-6.2,61.6,23.5c17.9-5.1,37-7.6,56.1-7.7c19,0.1,38.2,2.6,56.1,7.7   c42.8-29.7,61.5-23.5,61.5-23.5c12.2,31.6,4.5,55,2.2,60.8c14.3,16.1,23,36.6,23,61.6c0,88.2-52.4,107.6-102.3,113.3   c8,7.1,15.2,21.1,15.2,42.5c0,30.7-0.3,55.5-0.3,63c0,6.1,4,13.3,15.4,11C415.9,449.1,480,363.1,480,261.7   C480,134.8,379.7,32,256,32z"/>
</svg>

<span class="new-window"><svg  height="8px"  style="enable-background:new 0 0 1000 1000;" version="1.1" viewBox="0 0 1000 1000" width="8px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
<path d="M598 128h298v298h-86v-152l-418 418-60-60 418-418h-152v-86zM810 810v-298h86v298c0 46-40 86-86 86h-596c-48 0-86-40-86-86v-596c0-46 38-86 86-86h298v86h-298v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/>
</svg>
</span></a>



<a href="https://medium.com/@salmaan.rashid/" target="_blank" class="link-transition medium link dib z-999 pt3 pt0-l mr1" title="Medium link" rel="noopener" aria-label="follow on Medium——Opens in a new window">
  <svg  height="32px"  style="enable-background:new 0 0 170 170;" version="1.1" viewBox="0 0 170 170" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
<path d="M46.5340803,65.2157554 C46.6968378,63.6076572 46.0836,62.018231 44.8828198,60.93592 L32.6512605,46.2010582 L32.6512605,44 L70.6302521,44 L99.9859944,108.380952 L125.794585,44 L162,44 L162,46.2010582 L151.542017,56.2281011 C150.640424,56.9153477 150.193188,58.0448862 150.380019,59.1628454 L150.380019,132.837155 C150.193188,133.955114 150.640424,135.084652 151.542017,135.771899 L161.755369,145.798942 L161.755369,148 L110.38282,148 L110.38282,145.798942 L120.963119,135.527337 C122.002801,134.487948 122.002801,134.182246 122.002801,132.592593 L122.002801,73.0417402 L92.585901,147.755438 L88.6106443,147.755438 L54.3622782,73.0417402 L54.3622782,123.115814 C54.0767278,125.221069 54.7759199,127.3406 56.2581699,128.863022 L70.0186741,145.55438 L70.0186741,147.755438 L31,147.755438 L31,145.55438 L44.7605042,128.863022 C46.2319621,127.338076 46.8903838,125.204485 46.5340803,123.115814 L46.5340803,65.2157554 Z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/>
</svg>

<span class="new-window"><svg  height="8px"  style="enable-background:new 0 0 1000 1000;" version="1.1" viewBox="0 0 1000 1000" width="8px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
<path d="M598 128h298v298h-86v-152l-418 418-60-60 418-418h-152v-86zM810 810v-298h86v298c0 46-40 86-86 86h-596c-48 0-86-40-86-86v-596c0-46 38-86 86-86h298v86h-298v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/>
</svg>
</span></a>




    </div>
  </div>
</nav>

      <div class="tc-l pv6 ph3 ph4-ns">
        
          <h1 class="f2 f1-l fw2 white-90 mb0 lh-title">Envoy Global rate limiting helloworld</h1>
          
        
      </div>
    </div>
  </header>



    <main class="pb7" role="main">
      
  
  <article class="flex-l flex-wrap justify-between mw8 center ph3">

    <header class="mt4 w-100">
      <p class="f6 b helvetica tracked">
          
        ARTICLES
      </p>
      <h1 class="f1 athelas mb1">Envoy Global rate limiting helloworld</h1>
      
      
      <time class="f6 mv4 dib tracked" datetime="2019-10-22T14:34:01-08:00">October 22, 2019</time>
      
      
    </header>

    <section class="nested-copy-line-height lh-copy serif f4 nested-links nested-img mid-gray pr4-l w-two-thirds-l">

<p>Sample &ldquo;hello world&rdquo; application demonstrating basic aspects fo Envoy&rsquo;s <a href="https://www.envoyproxy.io/docs/envoy/v1.5.0/intro/arch_overview/global_rate_limiting">Global Rate Limiting</a> capability.  This app configures a local envoy instance for an <a href="https://www.envoyproxy.io/docs/envoy/v1.5.0/configuration/http_filters/rate_limit_filter#config-http-filters-rate-limit">HTTP level rate limit filter</a> and then uses <a href="https://github.com/lyft/ratelimit">Lyft&rsquo;s RateLimit Service</a> as the backend.</p>

<p>Envoy&rsquo;s rate limit functions checks each request to see if it should go through or not either using a local instance specific criteria or globally.  By local, the rate limit counter runs within the context of the single envoy proxy that handles the request.  This means each proxy keeps track of the connections it manages and applies <a href="https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/upstream/circuit_breaking">circuit braking</a>.  Global means there a single counter for all proxies will use as a basis for evaluating the request.  Each proxy asks an upstream Rate Limiting Service (Lyfts, in this example) that would run outside of envoy for a decision on the request.</p>

<p>As this is just a tutorial, helloworld, we will use a single Envoy instance that talks to Lyft&rsquo;s Rate limiting gRPC service that also runs on the same machine.  Realistically, you probably want set this up to run within a kubernetes cluster with envoy as a sidecar and the rate limiting service running by itself.</p>

<p>Please also review the following</p>

<ul>
<li><a href="https://engineering.dollarshaveclub.com/rate-limiting-with-guardian-6520bc84508d">Rate Limiting with Guardian</a></li>
<li><a href="https://medium.com/dm03514-tech-blog/sre-resiliency-bolt-on-sidecar-rate-limiting-with-envoy-sidecar-5381bd4a1137">SRE: Resiliency: Bolt on Rate Limiting using Envoy</a></li>
<li><a href="https://medium.com/@__xuorig__/understanding-envoyproxys-rate-limiting-cb3e00c9be2d">Understanding EnvoyProxy’s Rate Limiting</a></li>
</ul>

<p>note: I did not this this at scale and don&rsquo;t know how it impacts performance since each requests is checked.</p>

<h3 id="global-rate-limiting-scheme">Global rate limiting scheme</h3>

<p>We&rsquo;re running a stock quote service at endpoint:</p>

<p><code>/quote</code>:  Get stock quote
Users are authenticated using the standard HTTP_AUTHORIZATION (<code>Authorization: Bearer token</code>).
The quote service has two levels of service: basic and enhanced where the service level is requested as a header value.</p>

<p>We would like to setup rate limit controls such that:</p>

<ol>
<li>Anonymous users (not auth token) are allowed 2 req/min of any service level</li>
<li>Users with auth allowed upto 20 req/min of any service level</li>
<li>Users with auth and &ldquo;enhanced&rdquo; service level allowed 10 req/min</li>
<li>Users with auth and &ldquo;basic&rdquo; service level allowed 15 req/min</li>
</ol>

<p>Which means a single authenticated user can make with in one minute
- 15 basic  + 5 enhanced
- 10 basic  + 10 enhanced</p>

<p>So how do we do this with envoy?  Basically you define rules in the envoy filters that constructs a vector of key-value messages (called descriptors) to the external rate limiting service.  This took me sometime to understand but you basically have carefully construct the data thats emitted from Envoy and match that with a configuration on the Rate Limiting Service.</p>

<p>To separate out the authorization limits form the actual rate control, we split the checks into envoy filter stages.  The first split up the http handlers in envoy into two stages.  The first stage just checks and limits the authorization header existence while the second stage does the actual policy checks we defined</p>

<h3 id="setup-rate-limiting-service">Setup Rate Limiting Service</h3>

<p>Lyft&rsquo;s service implementation uses redis so run:</p>

<pre><code class="language-bash">docker run -p 6379:6379 redis
</code></pre>

<p>Then setup some env variables and run the service</p>

<pre><code class="language-bash">export USE_STATSD=false 
export LOG_LEVEL=debug 
export REDIS_SOCKET_TYPE=tcp 
export REDIS_URL=localhost:6379 
export RUNTIME_ROOT=`pwd`/runtime_root/ 
export RUNTIME_SUBDIRECTORY=ratelimit


git clone https://github.com/lyft/ratelimit.git
cd ratelimit

# the following is done since Lyft glide-based install doens' support go modules in my version
# https://github.com/lyft/ratelimit/pull/101

rm go.mod
go run src/service_cmd/main.go
</code></pre>

<p>Once you run the service, you should see the configurations loaded:</p>

<pre><code>DEBU[0000] loading domain: apis                         
DEBU[0000] loading descriptor: key=apis.header_match_quote-path-vip 
DEBU[0000] loading descriptor: key=apis.header_match_quote-path-vip.priority-level_enhanced ratelimit={requests_per_unit=15, unit=MINUTE} 
DEBU[0000] loading descriptor: key=apis.header_match_quote-path-vip.service-level_basic ratelimit={requests_per_unit=10, unit=MINUTE} 
DEBU[0000] loading descriptor: key=apis.header_match_quote-path-user-limit 
DEBU[0000] loading descriptor: key=apis.header_match_quote-path-user-limit.auth_token ratelimit={requests_per_unit=20, unit=MINUTE} 
DEBU[0000] loading descriptor: key=apis.header_match_quote-path-auth ratelimit={requests_per_unit=2, unit=MINUTE} 
</code></pre>

<h3 id="setup-backend-and-envoy">Setup backend and Envoy</h3>

<p>Download envoy binary <a href="https://www.getenvoy.io/">here</a></p>

<p>The &lsquo;backend&rsquo; for our quote service is just a fake upstream service (it really doens&rsquo;t matter since we&rsquo;re focusing on envoy and ratelimits).  In our example here, we just use nginx as s the quote service.  Run</p>

<pre><code>docker run -p 11000:80 nginx
</code></pre>

<p>(as an aside, i tried to use <a href="https://www.envoyproxy.io/docs/envoy/latest/api-v2/api/v2/route/route.proto#envoy-api-field-route-route-direct-response">direct_response</a> as the backend but that did not honor rate limits)</p>

<p>Run Envoy</p>

<pre><code>envoy -c bbc.yaml -l debug
</code></pre>

<p>At this point, the rate limiters should be working.</p>

<h3 id="testing">Testing</h3>

<p>Lets go through the criteria we seutp earlier;</p>

<h4 id="1-anonymous-access">1. Anonymous access</h4>

<p>For the stage0 anonymous users:  we can achieve that by applying <code>header_value_match</code> <a href="https://www.envoyproxy.io/docs/envoy/v1.5.0/api-v2/rds.proto#ratelimit-action">RateLimit.Action</a> that emits values if the Authorization header <em>is not found</em> (note the <code>expect_match: false</code> setting)</p>

<pre><code class="language-yaml">              rate_limits:
              - actions:                                 
                - header_value_match:
                    descriptor_value: quote-path-auth
                    expect_match: false
                    headers:
                    - name: &quot;:path&quot;
                      exact_match: &quot;/quote&quot;
                    - name: &quot;Authorization&quot;                      
                stage: 0
</code></pre>

<p>THe corresponding Lyft configuration that handles the descriptor above is</p>

<pre><code class="language-yaml">- key: header_match
  value: quote-path-auth
  rate_limit:
    unit: minute
    requests_per_unit: 2
</code></pre>

<p>For reference, see
 - <a href="https://www.envoyproxy.io/docs/envoy/latest/configuration/http/http_filters/rate_limit_filter#config-http-filters-rate-limit-composing-actions">composing actions</a>
 - <a href="https://www.envoyproxy.io/docs/envoy/latest/api-v2/api/v2/route/route.proto.html?highlight=route#route-headermatcher">route.HeaderMatcher</a>
 - <a href="https://www.envoyproxy.io/docs/envoy/latest/api-v2/api/v2/route/route.proto.html?highlight=route#route-ratelimit-action">route.RateLimit.Action</a></p>

<p>Which means a descriptor like <code>(&quot;header_match&quot;, &quot;quote-path-auth&quot;)</code> gets sent everytime the Authorization header isn&rsquo;t present an gets throttled at 2/min.</p>

<p>To test, in a new window run:</p>

<pre><code class="language-bash">$ for i in {1..1000}; do curl -s -o /dev/null -w &quot;$i-&gt;%{http_code} &quot;  http://localhost:10000/quote; sleep 1; done
  1-&gt;200 2-&gt;200 **3-&gt;429 4-&gt;429 5-&gt;429**
</code></pre>

<p>In the window where you are running the rate limit service, you should see the request counters incremented with each request and eventually a report that this vector is over the limit:</p>

<pre><code>DEBU[0110] looking up cache key: apis_header_match_quote-path-auth_1571615400 
DEBU[0110] cache key: apis_header_match_quote-path-auth_1571615400 current: 1 
DEBU[0111] cache key: apis_header_match_quote-path-auth_1571615400 current: 2 
DEBU[0112] cache key: apis_header_match_quote-path-auth_1571615400 current: 3 
..
DEBU[0120] [gostats] flushing counter ratelimit.service.rate_limit.apis.header_match_quote-path-auth.over_limit: 8
</code></pre>

<h4 id="2-authorized-access-without-service-level">2. Authorized access without Service level</h4>

<p>The second compounded limiter occurs if the <code>Authorization:</code> header is sent in and the counter the rate limiter uses is ofcourse not based on the simple existence of the header (which would be pretty useless) but a counter on every <em>distinct</em> value of that header.  Which means &ldquo;Authorization: Bearer Alice&rdquo; has different counter than &ldquo;Authorization: Bearer Bob&rdquo;.  (ahd yes, this is a contrived example&hellip;a JWT based bearer token can be different for the same user and would get counted different&hellip; this is just for demonstration.)</p>

<p>The envoy configuration that emits the Authorization header value only when the <code>/quote</code> path is invoked is</p>

<pre><code class="language-yaml">              - actions:                                 
                - header_value_match:
                    descriptor_value: quote-path-user-limit
                    headers:
                    - name: &quot;:path&quot;
                      exact_match: &quot;/quote&quot;
                - request_headers:
                    header_name: &quot;Authorization&quot;
                    descriptor_key: auth_token                                    
                stage: 1  
</code></pre>

<p>Which is emitted as:</p>

<p><code>(&quot;header_match&quot;, &quot;quote-path-user-limit&quot;).(&quot;auth_token&quot;, &quot;__value_of_authorization_header__&quot;))</code></p>

<p>Which matches the descriptor on the rate limiter:</p>

<pre><code class="language-yaml">- key: header_match
  value: quote-path-user-limit
  descriptors:
  - key: auth_token
    rate_limit:
      unit: minute
      requests_per_unit: 20
</code></pre>

<p>Each unique value for the authorization header is granted its own counter since the value itself isn&rsquo;t specified for the <code>auth_token</code> within the limiter.</p>

<p>Run the following  and see the requests get denied after 20 or so counts:</p>

<pre><code class="language-bash">$ for i in {1..1000}; do curl -s -H &quot;Authorization: alice&quot; -o /dev/null -w &quot;$i-&gt;%{http_code} &quot;  http://localhost:10000/quote; sleep 1; done 
   1-&gt;200 2-&gt;200 3-&gt;200 4-&gt;200 5-&gt;200 6-&gt;200 7-&gt;200 8-&gt;200 9-&gt;200 10-&gt;200 11-&gt;200 12-&gt;200 13-&gt;200 14-&gt;200 15-&gt;200 16-&gt;200 17-&gt;200 18-&gt;200 19-&gt;200 20-&gt;200 **21-&gt;429**

$ for i in {1..1000}; do curl -s -H &quot;Authorization: bob&quot; -o /dev/null -w &quot;$i-&gt;%{http_code} &quot;  http://localhost:10000/quote; sleep 1; done 
   1-&gt;200 2-&gt;200 3-&gt;200 4-&gt;200 5-&gt;200 6-&gt;200 7-&gt;200 8-&gt;200 9-&gt;200 10-&gt;200 11-&gt;200 12-&gt;200 13-&gt;200 14-&gt;200 15-&gt;200 16-&gt;200 17-&gt;200 18-&gt;200 19-&gt;200 20-&gt;200 **21-&gt;429**
</code></pre>

<p>Note the cache key counters includes a bit about the value (again, this is a contrived example; don&rsquo;t use the actual Authorization header value!!)</p>

<pre><code>DEBU[0193] cache key: apis_header_match_quote-path-user-limit_auth_token_alice_1571618520 current: 1

DEBU[0430] cache key: apis_header_match_quote-path-user-limit_auth_token_bob_1571618760 current: 1
</code></pre>

<h4 id="3-authorized-access-with-service-level">3. Authorized access with Service level</h4>

<p>The third compound limiter further fine tunes the rate limiter using <em>two</em> header values:  <code>Authorization</code> and the <code>x-service-level</code> enumberated value.</p>

<p>In the follwoing, we are emitting the <code>x-service-level</code> header as value for the <code>/quote</code> path.  The <code>Authorization</code> header is emitted as well from the previous configuration.  (TODO: find a way to collapse the rules&hellip;)</p>

<pre><code class="language-yaml">              - actions:
                - header_value_match:
                    descriptor_value: quote-path-vip
                    headers:
                    - name: &quot;:path&quot;
                      exact_match: &quot;/quote&quot;                                       
                - request_headers:
                    header_name: &quot;x-service-level&quot;
                    descriptor_key: service-level                    
                stage: 1
</code></pre>

<p>Ratelimit</p>

<pre><code class="language-yaml">- key: header_match
  value: quote-path-vip
  descriptors:
  - key: service-level
    value: &quot;enhanced&quot;  
    rate_limit:
      unit: minute
      requests_per_unit: 15
  - key: service-level
    value: &quot;basic&quot;  
    rate_limit:
      unit: minute
      requests_per_unit: 10
</code></pre>

<p>What the rules above state is if the client emits an authorized <code>basic</code> and <code>enhanced</code> requests, the rate limit will hit at 10 and 15 respectively within one minute window (per user as governed by the <code>quote-path-user-limit</code> rule)</p>

<pre><code class="language-bash">$ for i in {1..1000}; do curl -s -H &quot;Authorization: alice&quot; -H &quot;x-service-level: basic&quot; -o /dev/null -w &quot;$i-&gt;%{http_code} &quot;  http://localhost:10000/quote; sleep 1; done 
  1-&gt;200 2-&gt;200 3-&gt;200 4-&gt;200 5-&gt;200 6-&gt;200 7-&gt;200 8-&gt;200 9-&gt;200 10-&gt;200 11-&gt;429

$ for i in {1..1000}; do curl -s -H &quot;Authorization: alice&quot; -H &quot;x-service-level: enhanced&quot; -o /dev/null -w &quot;$i-&gt;%{http_code} &quot;  http://localhost:10000/quote; sleep 1; done 
  1-&gt;200 2-&gt;200 3-&gt;200 4-&gt;200 5-&gt;200 6-&gt;200 7-&gt;200 8-&gt;200 9-&gt;200 10-&gt;200 11-&gt;200 12-&gt;200 13-&gt;200 14-&gt;200 15-&gt;200 16-&gt;429 17-&gt;429
</code></pre>

<p>Notice <strong>two</strong> counters are checked: one for the <code>quote-path-user-limit</code> and another for <code>quote-path-vip</code>.  WHich ever one gets hit first will deny the request.  In our exaple, the <code>quote-path-vip</code> was triggered first.</p>

<pre><code>DEBU[0018] cache key: apis_header_match_quote-path-user-limit_auth_token_balice_1571619840 current: 1
DEBU[0018] cache key: apis_header_match_quote-path-vip_service-level_basic_1571619840 current: 11

DEBU[0343] cache key: apis_header_match_quote-path-user-limit_auth_token_alice_1571620140 current: 11 
DEBU[0343] cache key: apis_header_match_quote-path-vip_service-level_enhanced_1571620140 current: 11
</code></pre>

<p>To see it the other way, invoke a &lsquo;basic&rsquo; request and cancel it once you see a deny</p>

<pre><code class="language-bash">$  for i in {1..1000}; do curl -s -H &quot;Authorization: bob&quot; -H &quot;x-service-level: basic&quot; -o /dev/null -w &quot;$i-&gt;%{http_code} &quot;  http://localhost:10000/quote; sleep 1; done 
1-&gt;200 2-&gt;200 3-&gt;200 4-&gt;200 5-&gt;200 6-&gt;200 7-&gt;200 8-&gt;200 9-&gt;200 10-&gt;200 11-&gt;429 12-&gt;429 ^C
</code></pre>

<p>Then immediately call the &lsquo;enhanced&rsquo; request.</p>

<pre><code class="language-bash">$ for i in {1..1000}; do curl -s -H &quot;Authorization: bob&quot; -H &quot;x-service-level: enhanced&quot; -o /dev/null -w &quot;$i-&gt;%{http_code} &quot;  http://localhost:10000/quote; sleep 1; done 
  1-&gt;200 2-&gt;200 3-&gt;200 4-&gt;200 5-&gt;200 6-&gt;200 7-&gt;200 8-&gt;200 9-&gt;429 10-&gt;429 11-&gt;429 12-&gt;429 13-&gt;429 14-&gt;429 15-&gt;429 16-&gt;429 
</code></pre>

<p>Notice that the enhanced request failed on the 9th request or so (well before the 15 we configured).  This is because the <code>quote-path-user-limit</code> was evaluated first and that caused the deny:</p>

<pre><code>DEBU[0676] cache key: apis_header_match_quote-path-user-limit_auth_token_bob_1571620500 current: 20
DEBU[0676] cache key: apis_header_match_quote-path-vip_service-level_enhanced_1571620500 current: 9 
</code></pre>

<h3 id="notes">Notes:</h3>

<ul>
<li>Lyfts Rate limiter is pretty basic: its just a window based limit and lacks more advanced constructs like Token Bucket,etc.  The docs do state they may add on more types as demand increases</li>
<li>The envoy rate limiting is pretty abstract..it was a bit difficult for me to understand even basic operations&hellip;there much i can improve here in this article the more learn.  Please do feel free to suggest improvements if you figure out more advanced usage.</li>
</ul>

<h2 id="references">References</h2>

<ul>
<li><a href="https://cloud.google.com/solutions/rate-limiting-strategies-techniques">Rate-limiting strategies and techniques</a></li>
<li><a href="https://www.envoyproxy.io/docs/envoy/latest/api-v2/api/v2/route/route.proto#route-ratelimit">route.RateLimit</a></li>
<li><a href="https://github.com/envoyproxy/data-plane-api/blob/master/envoy/service/ratelimit/v2/rls.proto">rls.proto</a></li>
<li><a href="https://www.envoyproxy.io/docs/envoy/latest/api-v2/config/filter/http/rate_limit/v2/rate_limit.proto">config.filter.http.rate_limit.v2.RateLimit</a></li>
<li><a href="https://github.com/salrashid123/envoy_control">envoy discovery plane &lsquo;hello world&rsquo;</a></li>
</ul>
<ul class="pa0">
  
   <li class="list">
     <a href="/tags/envoy" class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">envoy</a>
   </li>
  
</ul>
<div class="mt6">
      
        <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "blog-6equj5-dev" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
      
      
      </div>
    </section>

    <aside class="w-30-l mt6-l">




</aside>

  </article>

    </main>
    <footer class="bg-black bottom-0 w-100 pa3" role="contentinfo">
  <div class="flex justify-between">
  <a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="https://blog.6equj5.dev/" >
    &copy; 2019 6equj5.dev
  </a>
    <div>






<a href="https://www.linkedin.com/in/salmaan-rashid-26b648" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedIn——Opens in a new window">
  <svg  height="32px"  style="enable-background:new 0 0 65 65;" version="1.1" viewBox="0 0 65 65" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
  <path d="M50.837,48.137V36.425c0-6.275-3.35-9.195-7.816-9.195  c-3.604,0-5.219,1.983-6.119,3.374V27.71h-6.79c0.09,1.917,0,20.427,0,20.427h6.79V36.729c0-0.609,0.044-1.219,0.224-1.655  c0.49-1.22,1.607-2.483,3.482-2.483c2.458,0,3.44,1.873,3.44,4.618v10.929H50.837z M22.959,24.922c2.367,0,3.842-1.57,3.842-3.531  c-0.044-2.003-1.475-3.528-3.797-3.528s-3.841,1.524-3.841,3.528c0,1.961,1.474,3.531,3.753,3.531H22.959z M34,64  C17.432,64,4,50.568,4,34C4,17.431,17.432,4,34,4s30,13.431,30,30C64,50.568,50.568,64,34,64z M26.354,48.137V27.71h-6.789v20.427  H26.354z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/>
</svg>

<span class="new-window"><svg  height="8px"  style="enable-background:new 0 0 1000 1000;" version="1.1" viewBox="0 0 1000 1000" width="8px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
<path d="M598 128h298v298h-86v-152l-418 418-60-60 418-418h-152v-86zM810 810v-298h86v298c0 46-40 86-86 86h-596c-48 0-86-40-86-86v-596c0-46 38-86 86-86h298v86h-298v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/>
</svg>
</span></a>


<a href="https://github.com/salrashid123" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="Github link" rel="noopener" aria-label="follow on Github——Opens in a new window">
  <svg  height="32px"  style="enable-background:new 0 0 512 512;" version="1.1" viewBox="0 0 512 512" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
  <path d="M256,32C132.3,32,32,134.8,32,261.7c0,101.5,64.2,187.5,153.2,217.9c11.2,2.1,15.3-5,15.3-11.1   c0-5.5-0.2-19.9-0.3-39.1c-62.3,13.9-75.5-30.8-75.5-30.8c-10.2-26.5-24.9-33.6-24.9-33.6c-20.3-14.3,1.5-14,1.5-14   c22.5,1.6,34.3,23.7,34.3,23.7c20,35.1,52.4,25,65.2,19.1c2-14.8,7.8-25,14.2-30.7c-49.7-5.8-102-25.5-102-113.5   c0-25.1,8.7-45.6,23-61.6c-2.3-5.8-10-29.2,2.2-60.8c0,0,18.8-6.2,61.6,23.5c17.9-5.1,37-7.6,56.1-7.7c19,0.1,38.2,2.6,56.1,7.7   c42.8-29.7,61.5-23.5,61.5-23.5c12.2,31.6,4.5,55,2.2,60.8c14.3,16.1,23,36.6,23,61.6c0,88.2-52.4,107.6-102.3,113.3   c8,7.1,15.2,21.1,15.2,42.5c0,30.7-0.3,55.5-0.3,63c0,6.1,4,13.3,15.4,11C415.9,449.1,480,363.1,480,261.7   C480,134.8,379.7,32,256,32z"/>
</svg>

<span class="new-window"><svg  height="8px"  style="enable-background:new 0 0 1000 1000;" version="1.1" viewBox="0 0 1000 1000" width="8px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
<path d="M598 128h298v298h-86v-152l-418 418-60-60 418-418h-152v-86zM810 810v-298h86v298c0 46-40 86-86 86h-596c-48 0-86-40-86-86v-596c0-46 38-86 86-86h298v86h-298v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/>
</svg>
</span></a>



<a href="https://medium.com/@salmaan.rashid/" target="_blank" class="link-transition medium link dib z-999 pt3 pt0-l mr1" title="Medium link" rel="noopener" aria-label="follow on Medium——Opens in a new window">
  <svg  height="32px"  style="enable-background:new 0 0 170 170;" version="1.1" viewBox="0 0 170 170" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
<path d="M46.5340803,65.2157554 C46.6968378,63.6076572 46.0836,62.018231 44.8828198,60.93592 L32.6512605,46.2010582 L32.6512605,44 L70.6302521,44 L99.9859944,108.380952 L125.794585,44 L162,44 L162,46.2010582 L151.542017,56.2281011 C150.640424,56.9153477 150.193188,58.0448862 150.380019,59.1628454 L150.380019,132.837155 C150.193188,133.955114 150.640424,135.084652 151.542017,135.771899 L161.755369,145.798942 L161.755369,148 L110.38282,148 L110.38282,145.798942 L120.963119,135.527337 C122.002801,134.487948 122.002801,134.182246 122.002801,132.592593 L122.002801,73.0417402 L92.585901,147.755438 L88.6106443,147.755438 L54.3622782,73.0417402 L54.3622782,123.115814 C54.0767278,125.221069 54.7759199,127.3406 56.2581699,128.863022 L70.0186741,145.55438 L70.0186741,147.755438 L31,147.755438 L31,145.55438 L44.7605042,128.863022 C46.2319621,127.338076 46.8903838,125.204485 46.5340803,123.115814 L46.5340803,65.2157554 Z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/>
</svg>

<span class="new-window"><svg  height="8px"  style="enable-background:new 0 0 1000 1000;" version="1.1" viewBox="0 0 1000 1000" width="8px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
<path d="M598 128h298v298h-86v-152l-418 418-60-60 418-418h-152v-86zM810 810v-298h86v298c0 46-40 86-86 86h-596c-48 0-86-40-86-86v-596c0-46 38-86 86-86h298v86h-298v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/>
</svg>
</span></a>



</div>
  </div>
</footer>

    

  <script src="/dist/js/app.3fc0f988d21662902933.js"></script>


  </body>
</html>
